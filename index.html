<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QMK Byte Array Viewer</title>
    <style>
      body,
      html {
        width: 100%;
        height: 100%;
      }

      input {
        margin: 0.2rem;
        padding: 0.2rem;
        border-radius: 0.2rem;
        border: 1px solid #aaa;
      }

      .main {
        width: 100%;
      }

      .split {
        padding: 0;
        width: 500px;
        height: 500px;
        max-height: 500px;
        display: inline-block;
        vertical-align: top;
      }

      #bitmap {
        width: 500px;
        height: 500px;
        border: 1px solid #aaa;
      }

      #output {
        margin: 0;
        width: 100%;
        height: 100%;
      }

      #oledCanvas {
        border: 1px solid #000;
        image-rendering: pixelated;
      }
    </style>

  <body>
    <section>
      <div>
        <h1>QMK OLED Byte Array Viewer</h1>
        <textarea
          rows="10"
          cols="100"
          id="arrayInput"
          placeholder="Paste your QMK byte array here..."
        ></textarea>
        <br />
        <button onclick="renderImage()">Render Image</button>
        <p>OLED Preview:</p>
        <canvas id="oledCanvas" width="128" height="32"></canvas>
      </div>
    </section>

    <section>
      <div>
        <form>
          <label>
            Height
            <input id="height" type="number" value="32" />
          </label>
          <label>
            Width
            <input id="width" type="number" value="128" />
          </label>
        </form>

        <div class="main">
          <div class="left split">
            <canvas id="bitmap" width="500" height="500"></canvas>
          </div>

          <div class="right split">
            <textarea
              name=""
              readonly
              cols="30"
              rows="10"
              id="output"
            ></textarea>
          </div>
        </div>
      </div>
    </section>

    <script> 
      const updateGrid = () => {
        width = parseInt(widthInput.value, 10);
        height = parseInt(heightInput.value, 10);
        
        fixScale();
        ctx.clearRect(0, 0, 500, 500);
        
        for (var i = 0; i < width; i++) {
          for (var j = 0; j < height; j++) {
            if (values[i][j]) {
              ctx.fillRect( i*scale, j*scale, scale, scale );	
            } else {
              ctx.strokeRect( i*scale, j*scale, scale, scale );	
            }
          }	
        }
      };

      const printImageCode = () => {
        output.value = "#define bitmap_name_height " + height + "\n";
        output.value += "#define bitmap_name_width " + width + "\n\n";
        output.value += "static const unsigned char PROGMEM bitmap_name[] = {\n";
        for (var i = 0; i < height; i++) {
          for (var j = 0; j < 8*Math.ceil(width/8); j++) {
            if (j % 8 == 0 ) output.value += ' B';

            if (j < width) {
              output.value += (values[j][i]) ? "1" : "0";	
            } else {
              output.value += 0;
            }
            
            if (j % 8 == 7) output.value += ",";
          }

          output.value += "\n";
        }

        output.value += "};\n\n";
        output.value += "display.drawBitmap(0, 0, bitmap_name, bitmap_name_width, bitmap_name_height, WHITE);";
      };

      const fixScale = () => {
        const limitingSize = (width > height) ? width : height;
        scale = (500/(limitingSize));
        scale = Math.min(scale, 50);
      };

      const activateMouseMoveHandler = (event) => {
        canvas.onmousemove = canvasClickHandler;
        canvasClickHandler(event);
      };

      const deactivateMouseMoveHandler = () => {
        brushColor = undefined;
        canvas.onmousemove = null;
        for (var i = 0; i < 256; i++) {
          pressedLocations[i] = new Array(256).fill(false);
        }
        
        printImageCode();
      };

      const canvasClickHandler = (event) => {
        const x = ((event.pageX - canvas.offsetLeft) - ((event.pageX - canvas.offsetLeft) % scale)) / scale;
        const y = ((event.pageY - canvas.offsetTop) - ((event.pageY - canvas.offsetTop) % scale)) / scale;
        if (brushColor === undefined) brushColor = !values[x][y];
        
        if (!pressedLocations[x][y]) {
          if (brushColor !== undefined) {
            values[x][y] = brushColor;
          } else {
            values[x][y] = !values[x][y];
          }
          
          pressedLocations[x][y] = true;
        }

        updateGrid();
      };

      const dimensionChanged = () => {
        updateGrid();
        printImageCode();
      };

      const renderImage = () => {
        const oledCanvas = document.getElementById("oledCanvas");
        const oledCtx = oledCanvas.getContext("2d");
        oledCtx.clearRect(0, 0, oledCanvas.width, oledCanvas.height);

        const input = document.getElementById("arrayInput").value;
        const byteArray = input.match(/\d+/g)?.map(Number);
        if (!byteArray) {
          alert("No valid byte data found.");
          return;
        }

        const width = 128;
        const height = 32;
        var byteIndex = 0;

        for (var page = 0; page < height / 8; page++) {
          for (var x = 0; x < width; x++) {
            const byte = byteArray[byteIndex++] || 0;

            for (var bit = 0; bit < 8; bit++) {
              const y = page * 8 + bit;
              if (y >= height) continue;

              const color = (byte >> bit) & 1 ? "#000" : "#FFF";
              ctx.fillStyle = color;
              ctx.fillRect(x, y, 1, 1);
            }
          }
        }
      };

      const output = document.getElementById('output');
      const canvas = document.getElementById('bitmap');
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = 'black';
      ctx.lineWidth = 2;

      var scale = 50;
      var width, height;
      var widthInput = document.getElementById( 'width' );
      var heightInput = document.getElementById( 'height' );

      var values = new Array(256);
      for (var i = 0; i < 256; i++) {
        values[i] = new Array(256).fill(false);
      }

      var pressedLocations = new Array(256);
      for (var i = 0; i < 256; i++) {
        pressedLocations[i] = new Array(256).fill(false);
      }

      var brushColor = undefined;
      updateGrid();
      printImageCode();

      canvas.onmousedown = activateMouseMoveHandler;
      canvas.onmouseup = deactivateMouseMoveHandler;
      canvas.onmouseout = deactivateMouseMoveHandler;
      heightInput.onchange = dimensionChanged;
      widthInput.onchange = dimensionChanged;
    </script>
  </body>
</html>
